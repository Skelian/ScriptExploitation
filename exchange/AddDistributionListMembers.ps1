<#
    Add members to a distribution list
    Exchange Online

    Usage:
        - Adding members from a CSV file:
            .\AddDistributionListMembers.ps1 -ListName <list name> -CsvPath <path to CSV file>

        - Adding members from an email list:
            .\AddDistributionListMembers.ps1 -ListName <list name> -EmailList <email list>

    Parameters:
        -ListName: The name of the distribution list to add members to.

    CSV file format:
    The CSV file should have a header row with the column name "email" that contains the email addresses of the members to be added.

    Example CSV file contents:
    email
    user1@example.com
    user2@example.com
    user3@example.com

    Email list format:
    The email list should contain member email addresses in the format "<name> <email>; <name> <email>; ..."

    Example email list contents:
    John Doe <johndoe@example.com>; Jane Smith <janesmith@example.com>
#>

Param(
    [parameter(Mandatory=$true)]
    [string]$ListName,
    
    [parameter(Mandatory=$false)]
    [string]$CsvPath,
    
    [parameter(Mandatory=$false)]
    [string]$EmailList
)

# Validate ListName parameter
if (-not (Get-DistributionGroup -Identity $ListName)) {
    Write-Output "Invalid distribution list name: $ListName"
    exit
}

Import-Module ExchangeOnlineManagement

Connect-ExchangeOnline

if ($CsvPath -and $EmailList) {
    Write-Output "Please provide either the -CsvPath or -EmailList parameter, not both."
    exit
}
elseif ($CsvPath) {
    # Validate CsvPath parameter
    if (-not (Test-Path -Path $CsvPath -PathType Leaf)) {
        Write-Output "Invalid CSV file path: $CsvPath"
        exit
    }

    $members = Import-Csv -Path $CsvPath -Delimiter ";"

    foreach ($member in $members) {
        Add-DistributionGroupMember -Identity $ListName -Member $member.email
    }
}
elseif ($EmailList) {
    # Parse email list
    $members = $EmailList -split ';'
    $memberEmails = @()
    foreach ($member in $members) {
        $memberInfo = $member.Trim() -split '<'
        $name = $memberInfo[0].Trim()
        $email = $memberInfo[1].Trim('>', ' ')
        $memberEmails += $email
    }

    foreach ($email in $memberEmails) {
        Add-DistributionGroupMember -Identity $ListName -Member $email
    }
}
else {
    Write-Output "Please provide either the -CsvPath or -EmailList parameter."
    exit
}

$members = Get-DistributionGroupMember -Identity $ListName
Write-Output "Members of the distribution list $ListName :"
$members
