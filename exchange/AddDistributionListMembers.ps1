<#
    Add members to a distribution list
    Exchange Online

    Usage:
        - Adding members from a CSV file:
            .\AddDistributionListMembers.ps1 -ListName <list name> -CsvPath <path to CSV file>

        - Adding members from an email list:
            .\AddDistributionListMembers.ps1 -ListName <list name> -EmailList <email list>

    Parameters:
        -ListName: The name of the distribution list to add members to.

    CSV file format:
    The CSV file should have a header row with the column name "email" that contains the email addresses of the members to be added.

    Example CSV file contents:
    email
    user1@example.com
    user2@example.com
    user3@example.com

    Email list format:
    The email list should contain member email addresses in the format "<name> <email>; <name> <email>; ..."

    Example email list contents:
    John Doe <johndoe@example.com>; Jane Smith <janesmith@example.com>
#>

Param(
    [parameter(Mandatory=$true)]
    [string]$ListName,
    
    [parameter(Mandatory=$false)]
    [string]$CsvPath,
    
    [parameter(Mandatory=$false)]
    [string]$EmailList
)

# Check if both CsvPath and EmailList are provided
if ($CsvPath -and $EmailList) {
    Write-Output "Please provide either CsvPath or EmailList, not both."
    exit
}
# Verify if either CsvPath or EmailList is provided
if (-not $CsvPath -and -not $EmailList) {
    Write-Output "Either CsvPath or EmailList must be provided."
    exit
}
# Check if the emails list is valid
$pattern = '^(?:\w+\s\w+\s<[\w.-]+@[\w.-]+>;\s)+$'
<# a retravailler ne fonctionne pas
if ($EmailList) {
    if ($EmailList -notmatch $pattern) {
        Write-Output "Invalid email list format."
        exit
    }
}
#>

Import-Module ExchangeOnlineManagement

Connect-ExchangeOnline

# Check if the distribution list exist
if (-not (Get-DistributionGroup -Identity $ListName)) {
    Write-Output "Invalid distribution list name: $ListName"
    exit
}

$members = @()

if ($CsvPath) {
    # Import members from CSV file
    if (Test-Path -Path $CsvPath) {
        $members = Import-Csv -Path $CsvPath -Header "email" -Delimiter ";" | ForEach-Object { $_.email }
    }
    else {
        Write-Output "Invalid CSV file path: $CsvPath"
        exit
    }
}

if ($EmailList) {
    # Parse email list and add members
    $members = $EmailList -split ';' | ForEach-Object {
        $memberInfo = $_.Trim() -split '<'
        $email = $memberInfo[1].Trim('>', ' ')
        $email
    }
}

# Add members to the distribution list
foreach ($member in $members) {
    Add-DistributionGroupMember -Identity $ListName -Member $member
	
	Write-Output "Member added: $member"
}
Write-Output ""
$finalList = Get-DistributionGroupMember -Identity $ListName
Write-Output "Members of the distribution list $ListName :"
$finalList

Disconnect-ExchangeOnline -Confirm:$false
