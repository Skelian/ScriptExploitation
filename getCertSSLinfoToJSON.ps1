param(
    [string]$fqdn='bing.com',
    [int]$port=443
)
# les arguments sont entrer en macro dans Zabbix

$url="https://"+$fqdn+":"+$port+"/"
[Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }
$req = [Net.HttpWebRequest]::Create($url)
try {$req.GetResponse() | Out-Null} catch {}

if($req.ServicePoint.Certificate -ne $null){
     
    #date en timestamp parce que plus simple a manipuler dans zabbix
    $CertEndDate = $req.ServicePoint.Certificate.GetExpirationDateString()
    $EndDateTimeStamp = Get-Date -Date $CertEndDate -UFormat %s
    $CertStartDate = $req.ServicePoint.Certificate.GetEffectiveDateString()
    $StartDateTimeStamp = Get-Date -Date $CertStartDate -UFormat %s

    #Sortie des donn√©es en JSON 
    [PSCustomObject]@{
        hash = $req.ServicePoint.Certificate.GetCertHashString()
        startDate = $StartDateTimeStamp
        endDate = $EndDateTimeStamp
        issuer = $req.ServicePoint.Certificate.Issuer
        subject = $req.ServicePoint.Certificate.Subject
    } | ConvertTo-Json
}
